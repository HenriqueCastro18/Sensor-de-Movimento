<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Simulador - Sensor de Estacionamento</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            background: #1a1a1a; 
            color: white; 
            margin: 0; 
            overflow: hidden; 
            transition: background 0.3s;
        }
        
        .header { padding: 20px; background: #252525; border-bottom: 2px solid #333; }
        .painel-leds { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .led { width: 50px; height: 50px; border-radius: 50%; border: 6px solid #010b11a1; background: #8b6a6a;
            opacity: 0.1; transition: 0.3s; }
        .verde.on { background: #2ecc71; box-shadow: 0 0 20px #2ecc71; opacity: 1; }
        .amarelo.on { background: #f1c40f; box-shadow: 0 0 20px #f1c40f; opacity: 1; }
        .vermelho.on { background: #e74c3c; box-shadow: 0 0 20px #fa1c04; opacity: 1; }

        .pista {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 25%;
            height: 120px;
            background: #333;
            border: 4px solid #444;
            border-left: 10px solid #ff4757;
            display: flex;
            align-items: center;
        }

        .sensor-label {
            position: absolute;
            left: -60px;
            top: -30px;
            color: #ff4757;
            font-size: 12px;
        }

        #carro {
            width: 100px;
            height: 60px;
            background: #3498db;
            border-radius: 10px;
            position: absolute;
            left: 236px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            user-select: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 10;
            transition: left 0.05s linear;
        }
        #carro:active { cursor: grabbing; border: 2px solid white; }

        .shake { animation: shake 0.2s ease-in-out 0s 2; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .info { margin-top: 10px; font-size: 1.2em; }
        .alerta { font-size: 1.5em; font-weight: bold; min-height: 40px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Simulador De Sensor</h1>
        <div class="painel-leds">
            <div id="led-vde" class="led verde"></div>
            <div id="led-ama" class="led amarelo"></div>
            <div id="led-ver" class="led vermelho"></div>
        </div>
        <div class="info" id="display-dist">Distância:  cm</div>
        <div id="alerta" class="alerta"></div>
    </div>

    <div class="pista" id="pista">
        <span class="sensor-label">SENSOR HC-SR04</span>
        <div id="carro"></div>
    </div>

    <script>
        const carro = document.getElementById('carro');
        const pista = document.getElementById('pista');
        const alerta = document.getElementById('alerta');
        let isDragging = false;

        carro.onmousedown = (e) => { isDragging = true; };
        document.onmouseup = () => { isDragging = false; };

        document.onmousemove = (e) => {
            if (!isDragging) return;

            let x = e.clientX - pista.offsetLeft - (carro.offsetWidth / 2);
            
            if (x < 0) x = 0;
            if (x > pista.offsetWidth - carro.offsetWidth) x = pista.offsetWidth - carro.offsetWidth;

            carro.style.left = x + 'px';

            const larguraUtil = pista.offsetWidth - carro.offsetWidth;
            const distanciaSimulada = Math.round((x / larguraUtil) * 198) + 2;
            
            atualizarServidor(distanciaSimulada);
        };

        async function atualizarServidor(dist) {
            try {
                const res = await fetch('/atualizar_sensor', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({distancia: dist})
                });
                const data = await res.json();

                document.getElementById('display-dist').innerText = `Distância: ${data.distancia- 2} cm`;
                
                document.getElementById('led-vde').classList.toggle('on', data.led_verde);
                document.getElementById('led-ama').classList.toggle('on', data.led_amarelo);
                document.getElementById('led-ver').classList.toggle('on', data.led_vermelho);

                if (data.bateu) {
                    alerta.innerText = " VOCÊ BATEU! ";
                    alerta.style.color = "#ffffff";
                    document.body.style.backgroundColor = "#550000";
                    carro.classList.add('shake');
                } else if (data.buzzer) {
                    alerta.innerText = " PARE IMEDIATAMENTE! ";
                    alerta.style.color = "#ff4757";
                    document.body.style.backgroundColor = "#1a1a1a";
                    carro.classList.remove('shake');
                } else {
                    alerta.innerText = "";
                    document.body.style.backgroundColor = "#1a1a1a";
                    carro.classList.remove('shake');
                }
            } catch (error) {
                console.error("Erro ao conectar com o servidor Flask:", error);
            }
        }
    </script>
</body>
</html>